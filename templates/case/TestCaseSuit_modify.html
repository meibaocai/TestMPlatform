{% extends 'base.html' %}{% load staticfiles %}{% block title %}    首页-测试管理平台{% endblock %}{% block page_title %}    <ul class="breadcrumb">        <li>            <i class="icon-home"></i>            <a href="/index">Home</a>            <i class="icon-angle-right"></i>        </li>        <li><a href="/case/ModifySuit/{{ all_suit.id }}/">我的工作台 > 修改执行集</a></li>    </ul>{% endblock %}{% block contend %}    <div class="row-fluid">        <div class="span6" style=" margin-left:15px;padding-left:-35px;" >            <div class="control-group">                <label class="control-label">执行集名称<span class="required">*</span></label>                <div class="controls">                <input type="text" id="suit_name" name="suit_name" data-required="1" class="span6 m-wrap" value="{{ all_suit.name }}">                </div>            </div>            <div class="control-group">            <label class="control-label">关联需求</label>            <div class="controls">                <select class="selectpicker" id="belong_requirement" name="belong_requirement"  multiple data-live-search="true" data-max-options="1"style="width:180px;" title="--请选择需求--">                    <option value=""></option>                    {% for Requirement in all_requirement %}                        <option value="{{ Requirement.id }}">{{ Requirement.name }}</option>                    {% endfor %}                </select>            </div>        </div>            <div class="control-group">            <label class="control-label">执行者<span class="required">*</span></label>            <div class="controls">                <select class="selectpicker" id="executor" name="executor"  multiple data-live-search="true" data-max-options="1"style="width:180px;" title="--请选择执行者--">                    {% for user in all_users %}                        <option value="{{ user.username }}">{{ user.username }}</option>                    {% endfor %}                </select>            </div>        </div>{{ select_Nodes|safe }}            <div class="control-group">            <label class="control-label">开始时间<span class="required">*</span></label>            <!--指定 date标记-->            <div class='input-group date'>                <input type='datetime-local' value="2019-11-11T00:00:00"  class="form-control"  id='start_time'/>                <span class="input-group-addon">                    <span class="glyphicon glyphicon-calendar"></span>                </span>            </div>        </div>            <div class="control-group">            <label class="control-label">结束时间<span class="required">*</span></label>            <!--指定 date标记-->            <div class='input-group date' >                <input type='datetime-local' value="2019-11-11T00:00:00" class="form-control" id='end_time' />                <span class="input-group-addon">                    <span class="glyphicon glyphicon-calendar"></span>                </span>            </div>        </div>            <div class="control-group">                <button type="button" class="btn green" id="addsuit_button" onclick="ModifySuit();">确认</button>                <button type="button" class="btn red" onclick="javascript:history.back(-1);" style="margin-left: 30px"> 取消</button>            </div>    </div>        <div class="span6" style=" margin-left:-0px;margin-right:-10px;" >            <div class="portlet box grey" style="margin-right:5px;height:650px; overflow:scroll;">                <div class="portlet-title ">                    <div class="caption"><i class="icon-comments"></i>版本用例集</div>                    <div class="actions">                        <a href="javascript:void(0);" id="expand" class="btn yellow"> 展开节点</a>                    </div>                </div>                <div class="portlet-body fuelux" >                    <ul id="treeDemo" class="ztree"></ul>                      <input type="hidden" id="ztree_value"  value="">                </div>            </div>        </div>    </div>{% endblock %}{% block myjs %}<script>     var setting = {                view: {                    selectedMulti: false,                    //addHoverDom: addHoverDom, //移入节点显示编辑按钮                    //removeHoverDom: removeHoverDom  //移入节点显示编辑按钮                },                check: {                    enable: true                },                callback: {                },                data: {                    simpleData: {                    enable: true                    }                    },                edit: {                enable: true,                    //editNameSelectAll: true,                    //showRemoveBtn: true,                    //removeTitle: "删除节点",                    //showRenameBtn: true,                    //renameTitle: "编辑节点"            }             };    //回填所属需求和执行周     $("#belong_requirement").selectpicker('val',"{{ all_suit.requirement_id|safe }}" );     $("#executor").selectpicker('val',"{{ all_suit.executor|safe }}" );     //初始化数结果 初始化ztree     zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, {{ Nodes|safe }});     //获取后台返回的选中的节点ID的list     var  Select_Nodes={{ Select_Nodes|safe}}     for( i=0;i<Select_Nodes.length;i++ )     {         //根据id在ztree的复选框中实现自动勾选        zTreeObj.checkNode( zTreeObj.getNodeByParam( "id",Select_Nodes[i]), true );        //将指定ID节点展开        zTreeObj.expandNode(zTreeObj.getNodeByParam( "id",Select_Nodes[i]), true, false);     }        //展开根节点    $('#expand').click(function () {            var zTree = $.fn.zTree.getZTreeObj("treeDemo");            var asyncForAll = false;            if (asyncForAll) {            zTree.expandAll(true);            }            else {            expandNodes(zTree.getNodes());            }        });        //展开根节点    function expandNodes(nodes) {            if (!nodes) return;            curStatus = "expand";            var zTree = $.fn.zTree.getZTreeObj("treeDemo");            for (var i=0, l=nodes.length; i<l; i++) {                zTree.expandNode(nodes[i], true, false, false);                if (nodes[i].isParent && nodes[i].zAsync) {                    expandNodes(nodes[i].children);                }            }        };    //获取勾选中的节点ID    function findChecked () {                    //获取复选框/单选框选中的节点：            var ids=[];            var zTreeObj = $.fn.zTree.getZTreeObj("treeDemo");            var checkedNodes = zTreeObj.getCheckedNodes(true);            for(var i=0;i<checkedNodes.length;i++)             {                 ids.push(checkedNodes[i].id);             }            return ids    }    function ModifySuit() {        //获取当前执行集id           var suit_id = {{ all_suit.id |safe}}            //获取勾选中的节点ID            var ids = findChecked();            //alert(ids);            var name = $("#suit_name").val();            var requirement_id = $("#belong_requirement").val();            var select_requirement = document.getElementById("belong_requirement");            //获得该下拉框所有的option的节点对象            var requirement_options = select_requirement.options;            //获得当前选中的option的索引            var requirement_index = select_requirement.selectedIndex;            //获得当前选中的option的文本内容            var requirement_name = requirement_options[requirement_index].text;            var executor = $("#executor").val();            var start_time = $("#start_time").val();            var end_time = $("#end_time").val();            if (name == null || name == "" || executor == null || executor == ""  || ids.length == 0  )            {                alert("执行集名称、指派人和用例集体必须填写或者勾选！");                return;            }            else {                $.ajax({                    type: 'post',                    url: '/case/ModifySuit/{{ all_suit.id |safe}}/',                    traditional:true,                    data: {                        "suit_id":suit_id,                        "ids":ids,                        "name":name,                        "requirement_id":requirement_id,                        "requirement_name":requirement_name,                        "executor":executor,                        "start_time":start_time,                        "end_time":end_time,                    },                    timeout: 5000, //超时时间设置，单位毫秒                    beforeSend: function (xhr, settings) {                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");                        },                    success: function (res) {                           if (res.code == 200) {                               //返回上一页并刷新：                            window.location.href = document.referrer;                        }                           else{                               alert(res.msg)                           }                    }                });            }    }</script>{% endblock %}