{% extends 'base.html' %}{% load staticfiles %}{% block title %}    首页-测试管理平台{% endblock %}{% block page_title %}    <ul class="breadcrumb">        <li>            <i class="icon-home"></i>            <a href="/index">Home</a>            <i class="icon-angle-right"></i>        </li>        <li><a href="/api/ModifyOperation/{{ all_opts.id }}/">API自动化 >前后置操作 >修改操作</a></li>    </ul>{% endblock %}{% block contend %}<div class="portlet-body form">    <!-- BEGIN FORM-->    <form action="/api/ModifyOperation/{{ all_opts.id }}/" class="form-horizontal"  method="post" >        {% csrf_token %}        <div class="control-group">            <label class="control-label">操作名称<span class="required">*</span></label>            <div class="controls">                <input type="text" id="name" name="name" value="{{ all_opts.name }}" data-required="1" class="span6 m-wrap">            </div>        </div>        <div class="control-group">            <label class="control-label">操作描述<span class="required">*</span></label>            <div class="controls">                <input type="text"id="desc" name="desc" value="{{ all_opts.desc }}" data-required="1" class="span6 m-wrap">            </div>        </div>        <div class="control-group">            <label class="control-label">环境&用例<span class="required">*</span></label>            <div class="controls">                <select class="selectpicker" id="belong_env" name="belong_env"   multiple data-live-search="false" data-max-options="1"style="width:120px;" title="--请选环境--">                        {% for envs in all_env %}                            <option value="{{ envs.id }}"> {{ envs.env_name }}</option>                        {% endfor %}                </select>                <select class="selectpicker" id="type" name="type"   multiple data-live-search="false" data-max-options="1"style="width:120px;" title="--请选操作类型--">                        <option value="0"> 执行测试用例</option>{#                        <option value="1">SQL类型</option>#}                        <option value="2">等待时间</option>                </select>            </div>        </div>        <div class="control-group"><div class="hr-line-dashed" style="border-top: 1px dashed lightgray;"></div></div>            <!-- case-value的隐藏div -->        <div  id="case-div" class="control-group"style="display: none" >            <div class="control-group">                <label class="control-label">选择用例<span class="required">*</span></label>                <div class="controls">                    <select class="selectpicker" multiple data-live-search="true" data-max-options="1" name="related_case" id="related_case"style="width:auto;" title="--请选择用例--">                         <option value="">--请选择用例--</option>                        {% for apicase in all_apicase %}                           <option value="{{ apicase.id }}">{{ apicase.api_name }}</option>                       {% endfor %}                    </select>                </div>            </div>            <div class="control-group" style="margin-top: 15px" >                <div id="toolbar">                    <button  id="add_param" class="btn green btn-sm" type="button">新增</button>                    <button id="del_param" class="btn red btn-sm" type="button">删除</button>                    <button class="btn blue btn-sm" type="button" onclick="optrundetail()">调测</button>                    <button id="get_param" class="btn btn-sm" type="button">Get</button>                </div>                <!-- case_rep_json用于存储case_rep_param表的数据 -->                <input type="hidden" name="case_rep_json" id="case_rep_json" value="{{ all_opts.operation }}">                <table class="table table-striped table-bordered table-hover" id="case_rep_param"></table>            </div>        </div>        <!-- SQL类型的隐藏div -->        <div id="sql-div" class="control-group" style="display: none" >            <div class="control-group">            <label class="control-label">SQL语句<span class="required">*</span></label>                <div class="controls">                    <textarea rows="3"  class="span6 m-wrap" id="opt_sql" name="opt_sql" data-value="{{ all_opts.operation }}"></textarea>                </div>            </div>            <div class="control-group">                <label class="control-label">返回值</label>                <div class="controls">                    <input type="text" id="opt_sql_value" name="opt_sql_value" value="{{ all_opts.operation }}" placeholder="SQL运行后的值" disabled="disabled">                </div>            </div>        </div>            <!-- key-value的隐藏div -->        <div id="delay-div" class="control-group" >            <label class="control-label">等待时间（秒）<span class="required">*</span></label>            <div class="controls">                <input type="text" id="opt_delay" name="opt_delay" value="{{ all_opts.operation }}" data-required="1" >            </div>        </div>        <div class="control-group" >            <H4  style="color: #1b23ff" align="center">{{ msg }}</H4>            <b style="color: #4b4cff">{% for key,error in ModifyOpts_Form.errors.items %}{{ key }}{{ error }}{% endfor %}</b>        </div>        <div class="form-actions">            <button type="submit" class="btn green ">确认</button>            <a href="{% url 'api:OperationList' %}">                <button type="button" class="btn" style="margin-left: 30px">取消</button>            </a>        </div>    </form>    <!-- END FORM-->                  <!-- 调试日志div,用于弹出浮层 -->    <div class="optrundetail" id="optrundetail" style="z-index:999;display: none; position:absolute; right:10px;height:600px;width:800px;overflow:auto;top: 50px; " >             <div class="control-group" >                    <button type="button" class="btn red icn-only" data-dismiss="modal"  style="float:right" onclick="closeDiv();"><i class="icon-remove icon-white"></i></button>                     <pre class="detail_opt" id="detail_opt" style="white-space: pre-wrap;word-wrap: break-word; margin-top: 10px;"></pre>            </div>    </div></div>{% endblock %}{% block myjs %}<script>        //根据服务端返回值让下拉框option选中    var opt_type = {{ all_opts.type|safe }};    ChangeType(opt_type);    $("#belong_env").selectpicker('val', {{ all_opts.belong_env.id|safe }});    $("#type").selectpicker('val', {{ all_opts.type|safe }});    $("#related_case").selectpicker('val', {{ all_opts.related_case.id|safe }});    $("#type").change(function() {        var opt_type = $("#type").val();        //alert(opt_type)        if (opt_type =="0")        {                $("#case-div").show();                $("#sql-div").hide();                $("#delay-div").hide();        }            if (opt_type =="1")        {            $("#case-div").hide();            $("#sql-div").show();            $("#delay-div").hide();        }        if (opt_type =="2")        {            $("#case-div").hide();            $("#sql-div").hide();            $("#delay-div").show();        }    //document.getElementById("key-value").style.display="";    });    function ChangeType(type)    {        var  opt_type={{ all_opts.type|safe }};        if (opt_type =="0")        {                $("#case-div").show();                $("#sql-div").hide();                $("#delay-div").hide();        }            if (opt_type =="1")        {            $("#case-div").hide();            $("#sql-div").show();            $("#delay-div").hide();        }        if (opt_type =="2")        {            $("#case-div").hide();            $("#sql-div").hide();            $("#delay-div").show();        }    }    let $case_rep_param = $('#case_rep_param');    let $add_param = $('#add_param');    let $get_param = $('#get_param');    let $del_param = $('#del_param');           //准备表头数据：    var case_rep_param_Columns = [{checkbox:true},{field:'ParamName', title:'ParamName'},{field:'HeaderName', title:'HeaderName'},{field:'CookieName', title:'CookieName'},{field:'JsonPath', title:'JsonPath'}];        //准表数据：    var case_rep_param_data={{ all_opts.operation |safe}};    //表格初始化    $('#case_rep_param').bootstrapTable({//表格初始化           columns: case_rep_param_Columns,  //表头           data:case_rep_param_data, //表格中的数据,这是从本地取得数据，如果是从后台取数据，就应该改为后台地址           clickEdit: true,           striped: true,                      //是否显示行间隔色           clickToSelect: true,                //是否启用点击选中行           halign: 'center',  // 设置表头标题对齐方式可选项           valign: 'middle',   // 设置单元格数据的垂直方向上的对齐方式           checkbox:true,           /**            * @param {点击列的 field 名称} field            * @param {点击列的 value 值} value            * @param {点击列的整行数据} row            * @param {td 元素} $element            */           onClickCell: function(field, value, row, $element) {               $element.attr('contenteditable', true);               $element.blur(function() {                   let index = $element.parent().data('index');                   let tdValue = $element.html();                   //old_value修改前的参数值                   saveData(index, field, tdValue);               })           }       });    //新增参数    $add_param.click(function() {           //获取表格行数rows           var rows=$($case_rep_param).bootstrapTable("getData").length;           $case_rep_param.bootstrapTable('insertRow', {                   index: rows,                   row: {                       ParamName: "", //刚新增的不确认是否正确                       HeaderName: "",                       CookieName: "",                       JsonPath: ""                   },               })       }) // 删除参数param    $del_param.on("click", function() {        if (!confirm("是否确认删除？"))            return;        var rows = $("#case_rep_param").bootstrapTable('getSelections');// 获得要删除的数据        //console.log(rows)        if (rows.length == 0) {// rows 主要是为了判断是否选中，下面的else内容才是主要            alert("请先选择要删除的记录!");            return;        }        else {            $(rows).each(function () {// 通过获得别选中的来进行遍历                $case_rep_param.bootstrapTable('remove', {                    field: 'ParamName',//对应该字段param的columns的field                    values: this.ParamName,//字段param的值                })            })        }    })     //获取table_param表json类型数据    $get_param.click(function() {               alert(JSON.stringify($case_rep_param.bootstrapTable('getData')));    });    //调试前后置操作    function optrundetail() {        var opt_id = eval({{ all_opts.id }});       //alert(opt_id);        $.ajax({                    type: 'POST',                    url: '/api/RunOperation',                    data: {                        "opt_id" : opt_id                            },                    timeout: 5000, //超时时间设置，单位毫秒                    beforeSend:function(xhr, settings){xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");},                    success: function (res) {                    $("#detail_opt").text("###################################################"+"\n参数取值如下："+"\n"+res.res_dict +"\n"+"###################################################\n"+res.detail_opt);                    $("#optrundetail").show();                    }            });       }    //保存表case_rep_param表输入的数据    function saveData(index, field, value) {        $case_rep_param.bootstrapTable('updateCell', {            index: index,       //行索引            field: field,       //列名            value: value        //cell值        })        $("#case_rep_json").val(JSON.stringify($case_rep_param.bootstrapTable('getData')));           }     //关闭模态框    function closeDiv() {                document.getElementById("optrundetail").style.display="none";    }</script>{% endblock %}